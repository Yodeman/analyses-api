package statsanal

import (
    "strings"
    "testing"

    "github.com/stretchr/testify/require"
    "gonum.org/v1/gonum/mat"

    "github.com/yodeman/analyses-api/util"
)

func TestLinearRegression(t *testing.T) {
    sampleCSV := `19.48,54.86,128,563,476,731,649,565,128
    19.59,54.23,129,563,477,731,649,565,125
    19.63,54.05,128,566,478,732,649,565,125
    19.64,53.74,128,566,478,732,649,565,125
    19.67,53.53,128,569,480,732,650,565,125
    19.67,53.53,126,570,481,733,650,565,123
    19.67,53.53,128,570,482,733,650,565,122
    19.67,53.51,127,570,482,733,650,565,122
    19.67,53.51,127,570,483,733,650,566,121
    19.67,53.51,127,573,485,732,650,566,121
    19.64,53.51,127,573,486,732,650,566,119
    19.64,53.51,127,574,487,732,650,566,119
    19.66,53.51,127,574,488,732,650,566,118
    19.66,53.51,127,574,489,732,650,566,118
    19.66,53.77,128,574,490,732,650,566,118
    19.66,53.82,128,576,493,732,650,566,118
    19.77,53.82,128,576,494,732,650,566,117
    19.77,53.35,128,576,496,731,650,566,117
    19.69,53.77,128,578,496,732,650,566,116
    19.66,53.82,128,578,496,732,650,566,116
    19.63,53.86,128,578,496,732,650,566,116
    19.63,53.87,128,579,496,732,650,566,116
    19.6,53.87,128,579,496,732,650,565,114
    19.57,53.87,128,581,497,732,650,565,114
    19.48,54.25,128,581,497,732,649,565,114
    19.48,54.38,128,581,498,731,649,565,114
    19.48,54.66,128,582,499,731,649,565,114
    19.48,54.66,128,582,499,731,649,565,114
    19.48,54.66,128,582,500,731,649,565,113
    19.5,54.66,131,582,500,731,649,565,113`

    tstatGT := "[[0.36592], [2.00788], [2.24806], [-0.47590], [-0.39411], [-2.98670], [-1.20966], [0.87740], [-0.67826]]"
    coeffsGT := "[[199.60969], [11.66467], [2.59601], [-0.12517], [-0.08513], [-0.48230], [-0.54345], [0.67493], [-0.33504]]"

    reader := strings.NewReader(sampleCSV)
    rows, cols, data, err := util.ParseCSVToFloatSlice(reader)
    require.NoError(t, err)
    require.Equal(t, 9, cols)
    require.Equal(t, 30, rows)

    m := mat.NewDense(rows, cols, data)
    coeffs, tstat, err := LinearRegression(m)
    require.NoError(t, err)
    require.Equal(t, coeffsGT, coeffs)
    require.Equal(t, tstatGT, tstat)
}
